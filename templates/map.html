<!doctype html>
<html lang="ja">

<head>
    {% include "_head.html" %}
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Map</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        main {
            height: calc(100vh - 4rem);
            width: 100%;
        }

        #drawer {
            transition: transform .25s ease;
        }

        #drawer.closed {
            transform: translateX(100%);
        }
    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/routes_view_minimized.css') }}">

</head>

<body>


    {% include "components/header.html" %}

    <!-- ãƒ¡ã‚¤ãƒ³ï¼ˆåœ°å›³ï¼‰ -->
    <main class="pt-16">
        <div id="map"></div>
    </main>

    <!-- ãƒ”ãƒ³ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="pinModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1001]">
        <div class="bg-white p-6 rounded-md w-full max-w-md sm:max-w-lg md:max-w-xl lg:max-w-2xl relative z-[1001] max-h-[90vh] overflow-y-auto">
            <h2 class="text-lg font-semibold mb-4">ãƒ”ãƒ³ã‚’ç™»éŒ²</h2>
            <form id="pinForm">
                <label class="block mb-2">åç§°ï¼ˆ1ã€œ30æ–‡å­—ï¼‰<span class="text-red-500">*</span></label>
                <input type="text" name="title" id="pinTitle" maxlength="30" class="w-full border p-2 mb-3" required>

                <label class="block mb-2">åˆ†é¡<span class="text-red-500">*</span></label>
                <select name="category" id="pinCategory" class="w-full border p-2 mb-3" required>
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="1">ğŸ½ï¸ é£Ÿã¹ã‚‹</option>
                    <option value="2">ğŸ‘ï¸ è¦‹ã‚‹</option>
                    <option value="3">ğŸ® éŠã¶</option>
                    <option value="4">ğŸ“š å­¦ã¶</option>
                    <option value="5">ğŸ¯ ä½“é¨“ã™ã‚‹</option>
                    <option value="6">ğŸ” æ¢ç´¢ã™ã‚‹</option>
                    <option value="7">ğŸ›‹ï¸ ä¼‘æ†©ã™ã‚‹</option>
                    <option value="8">ğŸ¨ æ³Šã¾ã‚‹</option>
                    <option value="9">ğŸ“¸ ãƒ•ã‚©ãƒˆã‚¹ãƒãƒƒãƒˆ</option>
                    <option value="10">ğŸª ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                    <option value="11">âš ï¸ æ³¨æ„ï¼</option>
                    <option value="12">ğŸ“¦ ãã®ä»–</option>
                </select>

                <!-- ä½æ‰€å…¥åŠ›æ¬„ -->
                <label class="block mb-2">ä½æ‰€ï¼ˆåœ°å›³ä¸Šã«ãƒ”ãƒ³ã‚’ç½®ãå ´åˆã¯ç©ºã§ã‚‚å¯ï¼‰</label>
                <input type="text" id="pinAddress" class="w-full border p-2 mb-3" placeholder="ä¾‹: å²©æ‰‹çœŒä¸€é–¢å¸‚å¤§ç”º1-1">


                <label class="block mb-2">å ´æ‰€ã®èª¬æ˜<span class="text-red-500">*</span></label>
                <textarea name="description" id="pinDescription" class="w-full border p-2 mb-3" required></textarea>

                <label class="block mb-2">æ³¨æ„äº‹é …</label>
                <textarea name="caution" id="pinCaution" class="w-full border p-2 mb-3"></textarea>

                <label class="block mb-2">å†™çœŸï¼ˆpng/jpegï¼‰</label>
                <input type="file" name="image" id="pinImage" accept="image/png, image/jpeg" class="w-full mb-3">

                <label class="block mb-2">è¡¨ç¤ºæœŸé™</label>
                <input type="datetime-local" name="expires_at" id="pinExpiresAt" class="w-full border p-2 mb-3">

                <div class="flex justify-end gap-2">
                    <button type="button" id="cancelPin" class="px-4 py-2 border rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">ç™»éŒ²ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ†é¡ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="categoryModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1002]">
        <div class="bg-white p-4 rounded-md w-full max-w-md max-h-[80vh] overflow-y-auto">
            <h2 class="text-lg font-semibold mb-4">åˆ†é¡ã‚’é¸æŠ</h2>
            <div id="categoryList" class="grid grid-cols-3 gap-2"></div>
            <button id="closeCategoryModal" class="mt-4 px-3 py-2 bg-gray-200 rounded">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ”ãƒ³åä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="pinListModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[1003]">
        <div class="bg-white p-4 rounded-md w-full max-w-md max-h-[80vh] overflow-y-auto">
            <h2 id="pinListTitle" class="text-lg font-semibold mb-4">åˆ†é¡ã®ãƒ”ãƒ³</h2>
            <ul id="pinList" class="space-y-2"></ul>
            <button id="closePinListModal" class="mt-4 px-3 py-2 bg-gray-200 rounded">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ã‚µã‚¤ãƒ‰ãƒ‰ãƒ­ãƒ¯ãƒ¼å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ« -->
    {% include "components/drawer.html" %}
    <!-- æ—…è·¯ä½œæˆç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã§èª­ã¿è¾¼ã‚€ -->
    {% include "components/route.html" %}
    <!-- æ—…è·¯é–²è¦§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã§èª­ã¿è¾¼ã‚€ -->
    {% include "components/routes_view.html" %}

    <!-- æ—…è·¯ä½œæˆç”¨jsãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="{{ url_for('static', filename='js/route.js') }}"></script>

    <!-- æ—…è·¯é–²è¦§ç”¨jsãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="{{ url_for('static', filename='js/routes_view.js') }}"></script>

    <script>
        // ãƒ‰ãƒ­ãƒ¯ãƒ¼é–‹é–‰
        const drawer = document.getElementById('drawer');
        const avatarBtn = document.getElementById('avatarBtn');
        const closeBtn = document.getElementById('closeDrawer');
        if (avatarBtn) avatarBtn.onclick = () => drawer.classList.toggle('closed');
        if (closeBtn) closeBtn.onclick = () => drawer.classList.add('closed');

        const searchBtn = document.getElementById('searchBtn');
        const categoryModal = document.getElementById('categoryModal');
        const closeCategoryModal = document.getElementById('closeCategoryModal');
        const categoryList = document.getElementById('categoryList');

        const categories = [
            { id: 1, name: "é£Ÿã¹ã‚‹", icon: "ğŸ½ï¸" },
            { id: 2, name: "è¦‹ã‚‹", icon: "ğŸ‘ï¸" },
            { id: 3, name: "éŠã¶", icon: "ğŸ®" },
            { id: 4, name: "å­¦ã¶", icon: "ğŸ“š" },
            { id: 5, name: "ä½“é¨“ã™ã‚‹", icon: "ğŸ¯" },
            { id: 6, name: "æ¢ç´¢ã™ã‚‹", icon: "ğŸ”" },
            { id: 7, name: "ä¼‘æ†©ã™ã‚‹", icon: "ğŸ›‹ï¸" },
            { id: 8, name: "æ³Šã¾ã‚‹", icon: "ğŸ¨" },
            { id: 9, name: "ãƒ•ã‚©ãƒˆã‚¹ãƒãƒƒãƒˆ", icon: "ğŸ“¸" },
            { id: 10, name: "ã‚¤ãƒ™ãƒ³ãƒˆ", icon: "ğŸª" },
            { id: 11, name: "æ³¨æ„ï¼", icon: "âš ï¸" },
            { id: 12, name: "ãã®ä»–", icon: "ğŸ“¦" }
        ];

        // åˆ†é¡ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getCategoryIcon(categoryId) {
            const category = categories.find(cat => cat.id === categoryId);
            return category ? category.icon : "ğŸ“¦";
        }

        searchBtn.onclick = () => {
            categoryList.innerHTML = '';
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg text-black text-center cursor-pointer bg-gradient-to-r from-amber-100/80 to-amber-200/80 border border-amber-300/60 shadow-md hover:shadow-lg transition-all duration-300`;
                div.innerHTML = `
                    <div class="text-2xl mb-1">${cat.icon}</div>
                    <div class="text-sm font-medium">${cat.name}</div>
                `;
                div.onclick = () => showPinsByCategory(cat.id, cat.name);
                categoryList.appendChild(div);
            });
            categoryModal.classList.remove('hidden');
        };

        closeCategoryModal.onclick = () => {
            categoryModal.classList.add('hidden');
        };

        const pinListModal = document.getElementById('pinListModal');
        const pinList = document.getElementById('pinList');
        const pinListTitle = document.getElementById('pinListTitle');
        const closePinListModal = document.getElementById('closePinListModal');

        closePinListModal.onclick = () => pinListModal.classList.add('hidden');

        async function showPinsByCategory(categoryId, categoryName) {
            pinListTitle.textContent = categoryName;
            pinList.innerHTML = '';

            const res = await fetch('/api/pins');
            const pins = await res.json();
            const filtered = pins.filter(p => p.category === categoryId);

            // filtered ã¯ title ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
            filtered.sort((a, b) => {
                const titleA = a.title ? String(a.title) : "";
                const titleB = b.title ? String(b.title) : "";
                return titleA.localeCompare(titleB, 'ja');
            });

            filtered.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p.title.length > 50 ? p.title.slice(0, 50) + "â€¦" : p.title;
                li.className = "cursor-pointer text-blue-600 hover:underline";
                li.onclick = () => {
                    pinListModal.classList.add('hidden');
                    pinListTitle.textContent = p.title;

                    // åœ°å›³ä¸­å¿ƒã‚’ãƒ”ãƒ³ã«ç§»å‹•ã—ã¦é–‹ã
                    const marker = pinLayer.getLayers().find(m => m.getLatLng && m.getLatLng().lat === parseFloat(p.lat) && m.getLatLng().lng === parseFloat(p.lng));
                    if (marker) {
                        map.setView([p.lat, p.lng], 16);
                        marker.openPopup();
                    }

                    // åˆ†é¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    const categoryModal = document.getElementById('categoryModal');
                    if (categoryModal) {
                        categoryModal.classList.add('hidden');
                    }
                };

                pinList.appendChild(li);
            });

            pinListModal.classList.remove('hidden');
        }

        // Leaflet åœ°å›³
        const bounds = L.latLngBounds([38.75, 140.95], [39.05, 141.30]); // ä¸€é–¢å¸‚ãƒ»å¹³æ³‰ç”º

        window.map = L.map('map', {
            zoomControl: true,
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        }).fitBounds(bounds, { padding: [0, 0] });

        // åœ°å›³ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
        setTimeout(() => {
            window.map.invalidateSize();
            // ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ç¯„å›²ã‚’èª¿æ•´
            window.map.fitBounds(bounds, { padding: [0, 0] });
        }, 100);

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«åœ°å›³ã‚µã‚¤ã‚ºã‚’å†èª¿æ•´
        window.addEventListener('resize', () => {
            setTimeout(() => {
                window.map.invalidateSize();
                // ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ç¯„å›²ã‚’å†èª¿æ•´
                window.map.fitBounds(bounds, { padding: [0, 0] });
            }, 100);
        });

        // åœ°å›³ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆGoogleãƒãƒƒãƒ—é¢¨ã®è¦‹ã‚„ã™ã„ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
        const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            minZoom: 12,
            maxZoom: 18,
            bounds: bounds,   // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¯„å›²åˆ¶é™
            noWrap: true,     // åœ°å›³æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);

        // åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå°†æ¥çš„ã«åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ï¼‰
        const mapStyles = {
            light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            voyager: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'
        };

        // ===== ãƒãƒƒãƒ—ãƒ”ãƒ³è¡¨ç¤ºç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ =====
        const pinLayer = L.layerGroup().addTo(map);

        // ===== DBã‹ã‚‰ãƒ”ãƒ³ã‚’å–å¾— =====
        let selectedLatLng = null;

        const addLocationBtn = document.getElementById('addLocationBtn');
        addLocationBtn.onclick = () => {
            document.getElementById("pinModal").classList.remove("hidden");
            selectedLatLng = null; // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ã¯ãªã„ã®ã§åˆæœŸåŒ–
        };

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        map.on("click", async (e) => {
            selectedLatLng = e.latlng;

            // ç°¡æ˜“é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
            let address = "ã“ã®åœ°ç‚¹";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
                const data = await res.json();
                if (data.display_name) address = data.display_name;
            } catch { }

            if (confirm(`${address} ã«ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
                document.getElementById("pinModal").classList.remove("hidden");
            }
        });

        async function fetchPins() {
            try {
                const res = await fetch("/api/pins");
                const pins = await res.json();

                pinLayer.clearLayers();
                const now = new Date();

                pins.forEach(pin => {
                    // è¡¨ç¤ºæœŸé™ãŒã‚ã‚‹å ´åˆã¯æç”»ã—ãªã„
                    const lat = parseFloat(pin.lat);
                    const lng = parseFloat(pin.lng);
                    if (!lat || !lng) return;

                    if (pin.expires_at) {
                        const expires = new Date(pin.expires_at);
                        if (!isNaN(expires) && expires < now) return;
                    }

                    let marker;

                    if (pin.image_url) {
                        // ç”»åƒãŒã‚ã‚‹å ´åˆã¯Googleãƒãƒƒãƒ—ãƒ”ãƒ³å½¢çŠ¶ã§ç”»åƒã‚’è¡¨ç¤º
                        const iconHtml = `
                            <div style="
                                position: relative;
                                width: 40px;
                                height: 50px;
                            ">
                                <!-- ãƒ”ãƒ³å½¢çŠ¶ã®èƒŒæ™¯ -->
                                <div style="
                                    position: absolute;
                                    bottom: 0;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    width: 0;
                                    height: 0;
                                    border-left: 8px solid transparent;
                                    border-right: 8px solid transparent;
                                    border-top: 20px solid #d32f2f;
                                "></div>
                                <!-- ãƒ”ãƒ³ã®æœ¬ä½“ï¼ˆå††å½¢ï¼‰ -->
                                <div style="
                                    position: absolute;
                                    bottom: 15px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    background-image: url(${pin.image_url});
                                    background-size: cover;
                                    background-position: center;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                "></div>
                            </div>
                         `;
                        const icon = L.divIcon({
                            html: iconHtml,
                            className: '', // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                            iconSize: [40, 50],
                            iconAnchor: [20, 50],
                            popupAnchor: [0, -50]
                        });
                        marker = L.marker([pin.lat, pin.lng], { icon: icon });
                    } else {
                        // ç”»åƒãŒãªã„å ´åˆã¯Googleãƒãƒƒãƒ—ãƒ”ãƒ³å½¢çŠ¶ã§ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
                        const categoryIcon = getCategoryIcon(pin.category);
                        const iconHtml = `
                            <div style="
                                position: relative;
                                width: 40px;
                                height: 50px;
                            ">
                                <!-- ãƒ”ãƒ³å½¢çŠ¶ã®èƒŒæ™¯ -->
                                <div style="
                                    position: absolute;
                                    bottom: 0;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    width: 0;
                                    height: 0;
                                    border-left: 8px solid transparent;
                                    border-right: 8px solid transparent;
                                    border-top: 20px solid #d32f2f;
                                "></div>
                                <!-- ãƒ”ãƒ³ã®æœ¬ä½“ï¼ˆå††å½¢ï¼‰ -->
                                <div style="
                                    position: absolute;
                                    bottom: 15px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    width: 32px;
                                    height: 32px;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    background-color: white;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 16px;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                ">${categoryIcon}</div>
                            </div>
                         `;
                        const icon = L.divIcon({
                            html: iconHtml,
                            className: '', // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                            iconSize: [40, 50],
                            iconAnchor: [20, 50],
                            popupAnchor: [0, -50]
                        });
                        marker = L.marker([pin.lat, pin.lng], { icon: icon });
                    }

                    marker.addTo(pinLayer);

                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹
                    let popupContent = `<strong>${pin.title}</strong><br>`;
                    popupContent += `${pin.description}<br>`;
                    if (pin.caution) popupContent += `<em style="color:red">æ³¨æ„: ${pin.caution}</em><br>`;
                    if (pin.image_url && !pin.image_url.includes('icon')) {
                        popupContent += `<img src="${pin.image_url}" width="100"><br>`;
                    }
                    if (pin.expires_at) popupContent += `è¡¨ç¤ºæœŸé™: ${new Date(pin.expires_at).toLocaleString()}<br>`;

                    marker.bindPopup(popupContent);
                });
            } catch (err) {
                console.error("ãƒ”ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", err);
            }
        }
        fetchPins();

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        map.on("click", async (e) => {
            selectedLatLng = e.latlng;

            // ç°¡æ˜“é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
            let address = "ã“ã®åœ°ç‚¹";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
                const data = await res.json();
                if (data.display_name) address = data.display_name;
            } catch { }

            if (confirm(`${address} ã«ãƒ”ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
                document.getElementById("pinModal").classList.remove("hidden");
            }
        });

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        document.getElementById("cancelPin").onclick = () => {
            document.getElementById("pinModal").classList.add("hidden");
        };

        //ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ã«ä½æ‰€å…¥åŠ›å¯¾å¿œã‚’è¿½åŠ 
        const pinForm = document.getElementById("pinForm");
        pinForm.onsubmit = async (evt) => {
            evt.preventDefault();
            const form = evt.target;
            const formData = new FormData(form);

            let lat = selectedLatLng?.lat;
            let lng = selectedLatLng?.lng;

            const address = document.getElementById("pinAddress").value.trim();

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ãŒãªã‘ã‚Œã°ä½æ‰€ã‹ã‚‰å–å¾—
            if (!lat && address) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                    const data = await res.json();
                    if (data.length === 0) {
                        alert("ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                        return;
                    }
                    lat = parseFloat(data[0].lat);
                    lng = parseFloat(data[0].lon);
                } catch (err) {
                    console.error(err);
                    alert("ä½æ‰€ã‹ã‚‰ä½ç½®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
                    return;
                }
            }

            if (!lat || !lng) {
                alert("åœ°å›³ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            formData.append("lat", lat);
            formData.append("lng", lng);


            // å¿…é ˆãƒã‚§ãƒƒã‚¯
            const title = formData.get("title").trim();
            const category = formData.get("category");
            const description = formData.get("description").trim();

            if (!title || title.length > 30) {
                alert("åç§°ã¯1æ–‡å­—ä»¥ä¸Š30æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!category) {
                alert("åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (!description) {
                alert("å ´æ‰€ã®èª¬æ˜ã¯å¿…é ˆã§ã™ã€‚");
                return;
            }

            try {
                const res = await fetch("/api/pins", {
                    method: "POST",
                    body: formData,
                    credentials: "same-origin"
                });
                const result = await res.json();

                if (result.success) {
                    document.getElementById("pinModal").classList.add("hidden");
                    form.reset();
                    fetchPins(); // ãƒãƒƒãƒ—æç”»æ›´æ–°
                } else {
                    alert(result.error || "ãƒ”ãƒ³è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            } catch (err) {
                alert("é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
                console.error(err);
            }
        };
    </script>

    <script src="{{ url_for('static', filename='js/routes_view.js') }}"></script>
    <script src="{{ url_for('static', filename='js/routes_view_minimized.js') }}"></script>

</body>

</html>
